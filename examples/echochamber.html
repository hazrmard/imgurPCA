<!DOCTYPE html>
<html>
<head>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style> /* set cosmetic properties */
        .line { 
            stroke: steelblue;
            stroke-width: 2;
            fill: none;
        }
        html, body, .container {
            padding: 0px;
            margin: 0px;
            height: 100%;
            width: 100%;
        }
        svg, .options {
            display: inline-block;
            vertical-align: top;
        }
    </style>
</head>

<body>
    <iframe style="position: absolute; display: none;"></iframe>
<div class="container">
<svg style="height: 75%; width: 75%"><g>
    <circle cx="100" cy="100" r="10" fill="blue"></circle>
    <circle cx="200" cy="300" r="20" fill="blue"></circle>
    <circle cx="500" cy="500" r="30" fill="blue"></circle>
</g></svg>
<div class="options" style="width: 23%; height: 100%">
    <div class="query-options">
        <input id="query" type="text" placeholder="Query"></input>
        <input id="btnQuery" type="button" value="Get"></input>
    </div>
    <div class="axes-options">
            
    </div>
    <div class="log-options">
            
    </div>
</div>
</div>

<script>
    {% autoescape false %}
    CS = "{{ CS }}";
    CID = "{{ CID }}";
    {% endautoescape %}

    var W = d3.select("svg")._groups[0][0].clientWidth;
    var H = d3.select("svg")._groups[0][0].clientHeight;
    var padding = (W > H ? W : H) / 20;
    var timeout = 1000;

    // Set up plotting
    var graph = d3.select("svg").select("g")
                    .attr("transform", "translate(" + padding + "," + padding + ")");
    var yScale = d3.scaleLinear().domain([0, 1]).range([H - 2*padding, 0]).clamp(true);
    var xScale = d3.scaleLinear().domain([0, 1]).range([0, W - 2*padding]).clamp(true);
    var xAxis = d3.axisBottom(xScale);
    var yAxis = d3.axisLeft(yScale);
    var line = d3.line()
                    .x(function(d, i) {return xScale(i)})
                    .y(function(d, i) {return yScale(d)});
    graph.append("g")
            .attr("class", "xaxis")
            .attr("transform", "translate(" + 0 + "," + (H - 2*padding) + ")")
            .call(xAxis);
    graph.append("g")
            .attr("class", "yaxis")
            .call(yAxis);
    var linePath = graph.append("path")
                        .attr("class", "line");

    // The update function requests new projections and re-plots
    function update(data) {
        console.log(data);
        // re-set scale domains and redraw axes
        xScale.domain([data.axesmin[0], data.axesmax[0]]);
        yScale.domain([data.axesmin[1], data.axesmax[1]]);
        graph.select(".xaxis")
                .transition().duration(timeout)
                .call(xAxis);
        graph.select(".yaxis")
                .transition().duration(timeout)
                .call(yAxis);
        // Plot points
        graph.selectAll("circle")
                .data(data.points)
                .transition().duration(timeout)
                .attr("cx", function (d) {return xScale(d[0])})
                .attr("cy", function (d) {return yScale(d[1])})
                .attr("r", function (d, i) {return Math.ceil(Math.log10(data.weights[i])) + "px"})
                .attr("fill", "red");
        graph.selectAll("circle")
            .data(data.points).enter().append("circle")
            .transition().delay(timeout).duration(0)
            .attr("cx", function (d) {return xScale(d[0])})
            .attr("cy", function (d) {return yScale(d[1])})
            .attr("r", "0px")
            .transition().duration(timeout)
                .attr("r", function (d, i) {return 5*Math.ceil(Math.log(data.weights[i])) + "px"})
                .attr("fill", "red");
        graph.selectAll("circle")
            .data(data.points).exit().remove();
    }

    document.getElementById("btnQuery").onclick = function() {
        queryPath = "/query/" + encodeURIComponent(document.getElementById("query").value);
        d3.json(queryPath, update);
    }

</script>
</body>
</html>
